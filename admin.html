<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Course Program Admin</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
  body { background: #f8f9fa; }
  .lectors-list span, .lectors-assigned span { display: inline-block; padding: 3px 6px; border-radius: 4px; color: #fff; margin: 2px; font-size: 0.85em; transition: all 0.2s; }
  .lectors-list span:hover, .lectors-assigned span:hover { transform: scale(1.05); }
  .fade-in { animation: fadeIn 0.3s ease-in; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity:1; transform: translateY(0); } }
  .container-admin { max-width: 900px; margin: auto; }
  .small-muted { font-size: 0.85em; color:#6c757d; display:block; }
</style>
</head>
<body class="p-3">

<div class="container container-admin">

<h1 class="mb-4 text-center">Course Program Admin</h1>

<!-- Lectors Section -->
<div class="card mb-4 fade-in">
  <div class="card-header">Manage Lectors</div>
  <div class="card-body">
    <div class="row g-2 mb-2">
      <div class="col-md-4"><input type="text" id="lector-name" class="form-control" placeholder="Lector short name (identifier)"></div>
      <div class="col-md-4"><input type="text" id="lector-realname" class="form-control" placeholder="Lector real name (full)"></div>
      <div class="col-md-2"><input type="color" id="lector-color" class="form-control form-control-color"></div>
      <div class="col-md-2"><button class="btn btn-primary w-100" onclick="addLectorMaster()">Add</button></div>
    </div>
    <div class="lectors-list" id="lectors-list"></div>
  </div>
</div>

<!-- Days Section -->
<div class="card mb-4 fade-in">
  <div class="card-header">Add Day</div>
  <div class="card-body">
    <div class="row g-2 mb-2">
      <div class="col-md-8"><input type="date" id="new-day" class="form-control"></div>
      <div class="col-md-4"><button class="btn btn-success w-100" onclick="addNewDay()">Add Day</button></div>
    </div>
    <div id="days-container"></div>
  </div>
</div>

<div class="d-flex gap-2 mb-4 flex-wrap">
  <button class="btn btn-outline-success" onclick="exportJSON()">Export JSON</button>
  <button class="btn btn-outline-primary" onclick="downloadJSON()">Download JSON</button>
  <button class="btn btn-outline-warning" onclick="copyJSON()">Copy JSON</button>
  <label class="btn btn-outline-secondary mb-0">
    Import JSON <input type="file" id="import-json" accept=".json" style="display:none" onchange="importJSON(event)">
  </label>
</div>

<pre id="json-output" class="bg-dark text-success p-3" style="max-height:400px; overflow:auto;"></pre>

<!-- Lector Edit Modal -->
<div class="modal fade" id="lectorModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Lector</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label>Short Name (identifier)</label>
          <input type="text" id="lector-modal-name" class="form-control">
        </div>
        <div class="mb-2">
          <label>Real Name (full)</label>
          <input type="text" id="lector-modal-realname" class="form-control">
        </div>
        <div class="mb-2">
          <label>Color</label>
          <input type="color" id="lector-modal-color" class="form-control form-control-color">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="lector-modal-save">Save</button>
      </div>
    </div>
  </div>
</div>


<!-- Block Modal -->
<div class="modal fade" id="blockModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Edit Block</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2"><label>Title</label><input type="text" id="modal-title" class="form-control"></div>
        <div class="row g-2 mb-2" id="modal-time-fields">
          <div class="col-md-6"><label>Start</label><input type="text" id="modal-start" class="form-control timepicker"></div>
          <div class="col-md-6" id="modal-end-container"><label>End</label><input type="text" id="modal-end" class="form-control timepicker"></div>
        </div>
        <div class="mb-2"><label>Type</label>
          <select id="modal-type" class="form-select" onchange="handleTypeChange()">
            <option>program</option>
            <option>jídlo</option>
            <option>teploměr</option>
            <option>zpětná vazba</option>
            <option>ostatní</option>
          </select>
        </div>
        <div class="mb-2" id="modal-tema-container">
          <label>Téma</label><input type="text" id="modal-tema" class="form-control" placeholder="Optional">
        </div>
        <div class="mb-2" id="modal-desc-container">
          <label>Description</label><textarea id="modal-desc" class="form-control"></textarea>
        </div>

        <!-- Lectors -->
        <div class="mb-2" id="modal-lectors-container">
          <label>Lectors</label>
          <div id="modal-lectors" class="mb-1"></div>
          <select id="modal-add-lector" class="form-select" onchange="modalAssignLector(this.value)">
            <option value="">--Add Lector--</option>
          </select>
        </div>

        <!-- Files -->
        <div class="mb-2" id="modal-files-container">
          <label>Files</label>
          <input type="file" id="modal-files" class="form-control" multiple onchange="modalHandleFiles(this.files)">
          <ul id="modal-files-list" class="mt-1"></ul>
        </div>

        <!-- Links -->
        <div class="mb-2" id="modal-links-container">
          <label>Links</label>
          <div class="d-flex mb-1 gap-2">
            <input type="url" id="modal-new-link-url" class="form-control" placeholder="URL">
            <input type="text" id="modal-new-link-desc" class="form-control" placeholder="Description">
            <button class="btn btn-secondary" onclick="addLink()">Add</button>
          </div>
          <ul id="modal-links-list" class="mt-1"></ul>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn btn-danger me-auto" onclick="removeBlockModal()">Remove Block</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button id="modal-save-btn" class="btn btn-primary" onclick="saveBlockModal()" disabled>Save Block</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
/* === Data and state === */
let schedule = [];
let masterLectors = []; // each {name, realName, color}
let currentModal = { day: null, index: null };
let blockModal = new bootstrap.Modal(document.getElementById('blockModal'));

let lectorModal = new bootstrap.Modal(document.getElementById('lectorModal'));
let currentLectorIndex = null;


/* --- Utilities --- */
function parseTimeToMinutes(t){
  if(!t) return null;
  const [h,m] = t.split(':').map(Number);
  if(Number.isNaN(h) || Number.isNaN(m)) return null;
  return h*60 + m;
}
function compareTimes(a,b){
  const am = parseTimeToMinutes(a);
  const bm = parseTimeToMinutes(b);
  if(am === null && bm === null) return 0;
  if(am === null) return 1; // move empty times to end
  if(bm === null) return -1;
  return am - bm;
}

/* --- Lectors --- */
function addLectorMaster() {
  const name = document.getElementById('lector-name').value.trim();
  const realName = document.getElementById('lector-realname').value.trim();
  const color = document.getElementById('lector-color').value;
  if(!name) return alert('Enter a name (short identifier)');
  // avoid duplicate short names
  if(masterLectors.find(l=>l.name===name)) return alert('A lector with that short name already exists');
  masterLectors.push({name, realName: realName || undefined, color});
  renderMasterLectors();
  document.getElementById('lector-name').value='';
  document.getElementById('lector-realname').value='';
}
function renderMasterLectors() {
  const list = document.getElementById('lectors-list');
  list.innerHTML='';
  masterLectors.forEach((l,i)=> {
    const container = document.createElement('div');
    container.className = 'd-inline-block me-2 mb-1';
    const span = document.createElement('span');
    span.style.background = l.color;
    span.style.cursor = 'pointer';
    span.textContent = l.name + (l.realName ? ` — ${l.realName}` : '');
    span.style.padding = '6px 10px';
    span.style.borderRadius = '6px';
    span.style.display = 'inline-block';
    span.title = l.realName ? `${l.realName}` : l.name;

    const editBtn = document.createElement('button');
    editBtn.className = 'btn btn-sm btn-light ms-1';
    editBtn.textContent = '✎';
    editBtn.onclick = () => editLector(i);

    const removeBtn = document.createElement('button');
    removeBtn.className = 'btn btn-sm btn-light ms-1';
    removeBtn.textContent = 'x';
    removeBtn.onclick = () => {
      if(!confirm(`Remove lector "${l.name}" from everything?`)) return;
      const removed = masterLectors.splice(i,1)[0];
      // remove from blocks
      schedule.forEach(day => day.blocks.forEach(block => {
        block.lectors = (block.lectors || []).filter(bl => bl.name !== removed.name);
      }));
      renderMasterLectors();
      renderDays();
      renderModalLectors();
    };

    container.appendChild(span);
    container.appendChild(editBtn);
    container.appendChild(removeBtn);
    list.appendChild(container);
  });
  renderModalLectors();
}

function editLector(index) {
  currentLectorIndex = index;
  const lector = masterLectors[index];
  document.getElementById('lector-modal-name').value = lector.name;
  document.getElementById('lector-modal-realname').value = lector.realName || '';
  document.getElementById('lector-modal-color').value = lector.color || '#000000';
  lectorModal.show();
}

document.getElementById('lector-modal-save').addEventListener('click', () => {
  if (currentLectorIndex === null) return;
  const lector = masterLectors[currentLectorIndex];

  const newName = document.getElementById('lector-modal-name').value.trim();
  const newReal = document.getElementById('lector-modal-realname').value.trim();
  const newColor = document.getElementById('lector-modal-color').value;

  if (!newName) return alert('Name cannot be empty');
  if (newName !== lector.name && masterLectors.find(l => l.name === newName)) {
    return alert('Another lector with that short name exists');
  }

  const oldName = lector.name;
  lector.name = newName;
  lector.realName = newReal || undefined;
  lector.color = newColor;

  // propagate changes
  schedule.forEach(day => day.blocks.forEach(block => {
    (block.lectors || []).forEach(bl => {
      if (bl.name === oldName) {
        bl.name = lector.name;
        bl.realName = lector.realName;
        bl.color = lector.color;
      }
    });
  }));

  renderMasterLectors();
  renderDays();
  renderModalLectors();
  lectorModal.hide();
});


/* --- Days / rendering --- */
const blockTypeStyles = {
  program: { color: "#0d6efd", icon: "📒" },
  jídlo: { color: "#28a745", icon: "🍽️" },
  "zpětná vazba": { color: "#ffc107", icon: "📝" },
  teploměr: { color: "#fd7e14", icon: "🌡️" },
  ostatní: { color: "#6c757d", icon: "⚪" },
};

function addNewDay() {
  const dateInput = document.getElementById('new-day').value;
  if(!dateInput) return alert('Select a date first');
  if(schedule.find(d=>d.date===dateInput)) return alert('Day already exists');
  createDay(dateInput);
}

function createDay(date) {
  const day = { date, blocks: [] };
  schedule.push(day);
  renderDays();
}

function renderDays(){
  const container=document.getElementById('days-container');
  container.innerHTML='';

  // sort days ascending by date
  schedule.sort((a,b) => a.date.localeCompare(b.date));

  schedule.forEach(day=>{
    // ensure blocks array exists
    day.blocks = Array.isArray(day.blocks) ? day.blocks : [];

    // sort blocks by start time (empty start -> last)
    day.blocks.sort((a,b) => compareTimes(a.start,b.start));

    const card=document.createElement('div');
    card.className='card mb-3 fade-in';

    const blockItems = day.blocks.map((b,i)=>{
      const style = blockTypeStyles[b.type] || blockTypeStyles["ostatní"];
      let duration = '';
      if(b.start && b.end && b.type !== 'teploměr'){
        const [sh, sm] = (b.start||'').split(':').map(Number);
        const [eh, em] = (b.end||'').split(':').map(Number);
        if(!Number.isNaN(sh) && !Number.isNaN(eh)){
          let minutes = (eh*60 + em) - (sh*60 + sm);
          duration = minutes>0 ? ` (${Math.floor(minutes/60)}h ${minutes%60}m)` : '';
        }
      }

      const lectors = (b.lectors || []).map(l => {
        // show short name + real name if available
        const rn = l.realName || (l.realName === undefined ? '' : l.realName);
        return rn ? `${l.name} (${rn})` : `${l.name}`;
      }).join(', ');

      return `
        <li class="list-group-item d-flex justify-content-between align-items-start" style="border-left:4px solid ${style.color}">
          <div>
            <span style="margin-right:5px">${style.icon}</span>
            <strong>${b.title || '(no title)'}</strong>
            ${b.tema ? '<br><small>Téma: '+escapeHtml(b.tema)+'</small>' : ''}
            ${b.start ? ' ' + escapeHtml(b.start) : ''}${b.end ? '-' + escapeHtml(b.end) : ''}${duration ? ' ' + duration : ''}
            ${lectors ? '<br><small>Lectors: ' + escapeHtml(lectors) + '</small>' : ''}
          </div>
          <div>
            <button class="btn btn-sm btn-primary ms-2" onclick="openBlockModal('${day.date}',${i})">Edit</button>
            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="duplicateBlock('${day.date}',${i})">Duplicate</button>
          </div>
        </li>
      `;
    }).join('');

    card.innerHTML=`
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">${day.date}</h5>
        <button class="btn btn-danger btn-sm" onclick="removeDay('${day.date}')">Remove Day</button>
      </div>
      <div class="card-body">
        <ul class="list-group mb-2">
          ${blockItems || '<li class="list-group-item">(no blocks)</li>'}
        </ul>
        <button class="btn btn-primary" onclick="addBlock('${day.date}')">Add Block</button>
      </div>
    `;
    container.appendChild(card);
  });
}

function removeDay(date){ if(confirm('Remove day?')){ schedule=schedule.filter(d=>d.date!==date); renderDays(); }}

/* --- Add Block with Defaults (ensure fresh arrays) --- */
function addBlock(date){
  const day = schedule.find(d=>d.date===date);
  if(!day) return;
  const block = {
    title: '',
    start: '',
    end: '',
    type: 'program',
    description: '',
    tema: '',
    lectors: [],
    files: [],
    links: []
  };
  day.blocks.push(block);
  renderDays();

  // Make sure modal input elements are cleared so they don't "carry over" files/links
  const fileInput = document.getElementById('modal-files');
  if(fileInput) fileInput.value = '';
  document.getElementById('modal-new-link-url').value = '';
  document.getElementById('modal-new-link-desc').value = '';

  openBlockModal(date, day.blocks.length - 1);
}

/* --- Modal Functions --- */
function openBlockModal(day,index){
  currentModal={day,index};
  const dayObj = schedule.find(d=>d.date===day);
  if(!dayObj) return;
  const block = dayObj.blocks[index];
  if(!block) return;

  // ensure arrays exist (backwards compat)
  if(!Array.isArray(block.lectors)) block.lectors = [];
  if(!Array.isArray(block.files)) block.files = [];
  if(!Array.isArray(block.links)) block.links = [];

  // ensure lector entries have realName property if missing (back-compat)
  block.lectors.forEach(l => {
    if(l.realName === undefined) l.realName = l.realName || undefined;
    if(!l.color) { const master = masterLectors.find(m=>m.name===l.name); if(master) l.color = master.color; }
  });

  document.getElementById('modal-title').value = block.title;
  document.getElementById('modal-start').value = block.start || '';
  document.getElementById('modal-end').value = block.end || '';
  document.getElementById('modal-type').value = block.type || 'program';
  document.getElementById('modal-desc').value = block.description || '';
  document.getElementById('modal-tema').value = block.tema || '';
  document.getElementById('modal-files-list').innerHTML = (block.files || []).map((f,i)=>`<li>${escapeHtml(f.name || f)} <button class="btn btn-sm btn-danger" onclick="modalRemoveFile(${i})">x</button></li>`).join('');

  renderModalLectors();
  renderModalLinks();

  // clear file input element to avoid auto-adding from previous selection
  const fileInput = document.getElementById('modal-files');
  if(fileInput) fileInput.value = '';

  blockModal.show();
  flatpickr(".timepicker",{enableTime:true,noCalendar:true,dateFormat:"H:i",time_24hr:true});
  handleTypeChange(true);
}

/* --- Type Based Visibility --- */
function handleTypeChange(){
  const type = document.getElementById('modal-type').value;
  const titleInput = document.getElementById('modal-title');

  // --- Set default titles for new blocks if empty ---
  if(!titleInput.value){
    if(type === 'teploměr') titleInput.value = 'Teploměr';
    else if(type === 'zpětná vazba') titleInput.value = 'Zpětná vazba';
  }

  const endContainer = document.getElementById('modal-end-container');
  const descContainer = document.getElementById('modal-desc-container');
  const temaContainer = document.getElementById('modal-tema-container');
  const lectorsContainer = document.getElementById('modal-lectors-container');
  const filesContainer = document.getElementById('modal-files-container');
  const linksContainer = document.getElementById('modal-links-container');

  if(type==='teploměr'){
    endContainer.style.display='none';
    descContainer.style.display='none';
    temaContainer.style.display='none';
    lectorsContainer.style.display='none';
    filesContainer.style.display='none';
    linksContainer.style.display='none';
  } else if(type==='zpětná vazba'){
    endContainer.style.display='block';
    descContainer.style.display='none';
    temaContainer.style.display='none';
    lectorsContainer.style.display='none';
    filesContainer.style.display='none';
    linksContainer.style.display='none';
  } else if(type==='jídlo'){
    endContainer.style.display='block';
    descContainer.style.display='block';
    temaContainer.style.display='none';
    lectorsContainer.style.display='none';
    filesContainer.style.display='none';
    linksContainer.style.display='none';
  } else {
    endContainer.style.display='block';
    descContainer.style.display='block';
    temaContainer.style.display='block';
    lectorsContainer.style.display='block';
    filesContainer.style.display='block';
    linksContainer.style.display='block';
  }

  checkRequiredFields();
}

function checkRequiredFields(){
  const type=document.getElementById('modal-type').value;
  const start=document.getElementById('modal-start').value;
  const end=document.getElementById('modal-end').value;
  const saveBtn=document.getElementById('modal-save-btn');
  if(!start) saveBtn.disabled=true;
  else if((type!=='teploměr' && type!=='jídlo' && type!=='zpětná vazba') && !end) saveBtn.disabled=true;
  else saveBtn.disabled=false;
}
document.getElementById('modal-start').addEventListener('input', checkRequiredFields);
document.getElementById('modal-end').addEventListener('input', checkRequiredFields);

/* --- Modal Save & Remove --- */
function saveBlockModal(){
  const dayObj = schedule.find(d=>d.date===currentModal.day);
  if(!dayObj) return;
  const block = dayObj.blocks[currentModal.index];
  if(!block) return;
  block.title=document.getElementById('modal-title').value;
  block.start=document.getElementById('modal-start').value;
  block.type=document.getElementById('modal-type').value;
  if(block.type!=='teploměr') block.end=document.getElementById('modal-end').value;
  else block.end = undefined;
  block.description=document.getElementById('modal-desc').value;
  block.tema=document.getElementById('modal-tema').value || undefined;
  renderDays();
  blockModal.hide();
}

function removeBlockModal(){
  const day=schedule.find(d=>d.date===currentModal.day);
  if(!day) return;
  if(confirm('Remove this block?')){ day.blocks.splice(currentModal.index,1); renderDays(); blockModal.hide(); }
}

/* --- Lectors in Modal --- */
function renderModalLectors(){
  const day = schedule.find(d=>d.date===currentModal.day);
  if(!day) return;
  const block = day.blocks[currentModal.index];
  if(!block) return;
  const container=document.getElementById('modal-lectors');
  container.innerHTML='';
  (block.lectors || []).forEach((l,i)=>{
    const span=document.createElement('span');
    span.style.background = l.color || '#666';
    span.style.color = '#fff';
    span.style.padding = '5px 8px';
    span.style.borderRadius = '5px';
    span.style.marginRight = '6px';
    span.style.cursor = 'pointer';
    span.textContent = l.name + (l.realName ? ` (${l.realName})` : '');
    span.onclick=()=>{ block.lectors.splice(i,1); renderModalLectors(); };
    container.appendChild(span);
  });

  const select=document.getElementById('modal-add-lector');
  select.innerHTML='<option value="">--Add Lector--</option>';
  masterLectors.forEach(l=>{
    if(!(block.lectors || []).find(bl=>bl.name===l.name)) select.innerHTML += `<option value="${escapeHtml(l.name)}">${escapeHtml(l.name + (l.realName ? ' — ' + l.realName : ''))}</option>`;
  });
}
function modalAssignLector(name){
  if(!name) return;
  const day=schedule.find(d=>d.date===currentModal.day);
  if(!day) return;
  const block = day.blocks[currentModal.index];
  if(!block) return;
  const l = masterLectors.find(m=>m.name===name);
  if(l) {
    // copy lector info as stored in master
    block.lectors = block.lectors || [];
    block.lectors.push({ name: l.name, realName: l.realName, color: l.color });
  }
  renderModalLectors();
}

/* --- Files --- */
function modalHandleFiles(files){
  const day=schedule.find(d=>d.date===currentModal.day);
  if(!day) return;
  const block = day.blocks[currentModal.index];
  if(!block) return;
  // ensure fresh array
  block.files = block.files || [];
  // append selected files (File objects). If running in browser the file objects are fine.
  block.files.push(...Array.from(files));
  renderModalFiles();
  // clear the input so that selecting the same file again triggers onchange and so a new block won't accidentally inherit
  const fileInput = document.getElementById('modal-files');
  if(fileInput) fileInput.value = '';
}
function renderModalFiles(){
  const day=schedule.find(d=>d.date===currentModal.day);
  if(!day) return;
  const block = day.blocks[currentModal.index];
  if(!block) return;
  document.getElementById('modal-files-list').innerHTML=(block.files || []).map((f,i)=>`<li>${escapeHtml(f.name || f)} <button class="btn btn-sm btn-danger" onclick="modalRemoveFile(${i})">x</button></li>`).join('');
}
function modalRemoveFile(i){
  const day=schedule.find(d=>d.date===currentModal.day);
  if(!day) return;
  const block = day.blocks[currentModal.index];
  if(!block) return;
  block.files.splice(i,1); renderModalFiles();
}

/* --- Links --- */
function renderModalLinks(){
  const day=schedule.find(d=>d.date===currentModal.day);
  if(!day) return;
  const block = day.blocks[currentModal.index];
  if(!block) return;
  document.getElementById('modal-links-list').innerHTML=(block.links || []).map((l,i)=>`<li>${escapeHtml(l.url)} (${escapeHtml(l.desc||'')}) <button class="btn btn-sm btn-danger" onclick="removeLink(${i})">x</button></li>`).join('');
}
function addLink(){
  const url=document.getElementById('modal-new-link-url').value.trim();
  const desc=document.getElementById('modal-new-link-desc').value.trim();
  if(!url) return alert('Enter URL');
  const day=schedule.find(d=>d.date===currentModal.day);
  if(!day) return;
  const block = day.blocks[currentModal.index];
  if(!block) return;
  block.links = block.links || [];
  block.links.push({url,desc});
  renderModalLinks();
  document.getElementById('modal-new-link-url').value='';
  document.getElementById('modal-new-link-desc').value='';
}
function removeLink(i){
  const day=schedule.find(d=>d.date===currentModal.day);
  if(!day) return;
  const block = day.blocks[currentModal.index];
  if(!block) return;
  block.links.splice(i,1); renderModalLinks();
}

/* --- Duplicate block --- */
function duplicateBlock(date, index){
  const day = schedule.find(d=>d.date===date);
  if(!day) return;
  const original = day.blocks[index];
  if(!original) return;
  // shallow deep-copy fields (files are File objects — we copy the references)
  const copy = {
    title: original.title,
    start: original.start,
    end: original.end,
    type: original.type,
    description: original.description,
    tema: original.tema,
    lectors: JSON.parse(JSON.stringify(original.lectors || [])), // deep copy plain objects
    files: Array.isArray(original.files) ? original.files.slice() : [],
    links: Array.isArray(original.links) ? JSON.parse(JSON.stringify(original.links)) : []
  };
  day.blocks.splice(index+1, 0, copy);
  renderDays();
}

/* --- JSON operations --- */
function exportJSON(){ document.getElementById('json-output').textContent=JSON.stringify(schedule,null,2); }
function downloadJSON(){ const blob = new Blob([JSON.stringify(schedule,null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='schedule.json'; a.click(); URL.revokeObjectURL(url); }
function copyJSON(){ navigator.clipboard.writeText(JSON.stringify(schedule,null,2)); alert('JSON copied'); }
function importJSON(event){
  const file=event.target.files[0]; 
  if(!file) return;
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const data=JSON.parse(e.target.result);
      if(!Array.isArray(data)) throw new Error('Invalid JSON');
      
      schedule=data.map(day=>{
        day.blocks = Array.isArray(day.blocks)?day.blocks:[];
        day.blocks.forEach(block=>{
          block.lectors=Array.isArray(block.lectors)?block.lectors:[];
          block.files=Array.isArray(block.files)?block.files:[];
          block.links=Array.isArray(block.links)?block.links:[];
          block.title = block.title||'';
          block.start = block.start||'';
          block.end = block.type==='teploměr'?undefined:(block.end||'');
          block.type = block.type||'program';
          block.description = block.description||'';
          block.tema = block.tema||undefined;
        });
        return day;
      });

      // 🔥 Build masterLectors automatically from imported blocks
      const lectorMap = {};
      schedule.forEach(day=>{
        day.blocks.forEach(block=>{
          block.lectors.forEach(l=>{
            lectorMap[l.name] = { name: l.name, color: l.color, realName: l.realName || "" };
          });
        });
      });
      masterLectors = Object.values(lectorMap);

      renderMasterLectors();
      renderDays();
      alert('JSON imported successfully');
    }catch(err){ 
      alert('Invalid JSON'); 
    }
  };
  reader.readAsText(file);
}


/* === small helpers === */
function escapeHtml(str){
  if(typeof str !== 'string') return str;
  return str.replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
}

/* --- Init --- */
renderMasterLectors();
renderDays();
</script>
</body>
</html>
